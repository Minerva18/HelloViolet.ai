<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: violet-conversations/lib/violetClientTx.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/docs-customization.css">
</head>

<body>

  <!-- HEADER FROM JEKYLL THEME -->
  <div id="header_wrap" class="outer">
      <header class="inner">
        <div id="top_banner">
          <a id="menu" href="/docs">Documentation</a>
          <a id="forkme_banner" href="{{ site.github.repository_url }}">View on GitHub</a>
        </div>

        <h1 id="project_title">Violet</h1>
        <h2 id="project_tagline">Enabling Sophisticated Voice Conversations</h2>

      </header>
  </div>
  <div id="main_wrap">

<div id="main">

    <h1 class="page-title">Source: violet-conversations/lib/violetClientTx.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* Copyright (c) 2017-present, salesforce.com, inc. All rights reserved */
/* Licensed under BSD 3-Clause - see LICENSE.txt or git.io/sfdc-license */


var ws = require('ws');

var createWSSAndListenForClient = (violetSrvr, srvrInstance)=>{
  var wss = new ws.Server({ server: srvrInstance });

  wss.on('connection', (ws) => {
    console.log('Client connected');
    ws.on('close', () => console.log('Client disconnected'));
  });

  var broadcast = (jsonObj) => {
    console.log('Broadcasting...', jsonObj);
    wss.clients.forEach((client) => {
      client.send(JSON.stringify(jsonObj));
    });
  }

  // return an overloaded violetSrvr object where we link the broadcaster to the target script
  return {
    loadScript: (path, name)=>{
      var script = violetSrvr.loadScript(path, name);
      if (script.setBroadcaster) script.setBroadcaster(broadcast);
    }
  };
};

module.exports = (violet, srvrInstance) => {
  if (violet.createAndListen) {
    console.log('clientTx - server initialization');
    return createWSSAndListenForClient(violet, srvrInstance);
  }

  // extend violet
  console.log('clientTx - conversation initialization');

  // setup basic notification functionality
  violet.broadcast = () => {console.log('Broadcasting not initialized...');}
  violet.setBroadcaster = (broadcaster) => {
    violet.broadcast = broadcaster;
  };
  // reimplement _sayFinish to also broadcast
  var oldSayFinish = violet.__get_sayFinish();
  violet.__set_sayFinish((resp, response, potResponses) => {
    var outStr = oldSayFinish(resp, response, potResponses);
    if (!outStr) return;
    violet.broadcast({
      response: outStr
    });
  });

  var fAlert = [];

  violet.setAlert = function(cause) {
    fAlert.push(cause);
    violet.broadcast({alert: fAlert.length > 0});
  };
  violet.clearAlert = function(cause) {
    var ndx = fAlert.indexOf(cause);
    if (ndx > 0) fAlert.splice(ndx, 1);
  };
  violet.respondTo({name: 'setAlert', expecting: ["set alert"], resolve: (response) => {response.setAlert('intent'); }});
  violet.respondTo({name: 'unsetAlert', expecting: ["disable alert", "clear alert"], resolve: (response) => {response.clearAlert('intent'); }});


};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-utils.html">utils</a></li><li><a href="module-violet.html">violet</a></li><li><a href="module-violetList.html">violetList</a></li><li><a href="module-violetSrvr.html">violetSrvr</a></li><li><a href="module-violetStorePG.html">violetStorePG</a></li><li><a href="module-violetStoreSF.html">violetStoreSF</a></li><li><a href="module-violetTime.html">violetTime</a></li></ul><h3>Classes</h3><ul><li><a href="module-violet.script-__getResponse-response.html">response</a></li><li><a href="module-violet.script-violet.html">violet</a></li></ul><h3>Global</h3><ul><li><a href="global.html#(unnamed)">(unnamed)</a></li><li><a href="global.html#Howdy">Howdy</a></li><li><a href="global.html#HowWork">HowWork</a></li><li><a href="global.html#Intro">Intro</a></li><li><a href="global.html#MajorIntent">MajorIntent</a></li><li><a href="global.html#setAlert">setAlert</a></li><li><a href="global.html#unsetAlert">unsetAlert</a></li><li><a href="global.html#WakeUp">WakeUp</a></li></ul>
</nav>

</div><!-- id="main_wrap" -->

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Nov 15 2017 18:33:02 GMT-0500 (EST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
